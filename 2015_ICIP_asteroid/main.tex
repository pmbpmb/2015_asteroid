% Template for ICIP-2015 paper; to be used with:
%          spconf.sty  - ICASSP/ICIP LaTeX style file, and
%          IEEEbib.bst - IEEE bibliography style file.
% --------------------------------------------------------------------------
\documentclass{article}
\usepackage{spconf,amsmath,graphicx}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows}
\usepackage{algorithmicx}
\usepackage[ruled]{algorithm}
\usepackage{algpseudocode}
% Example definitions.
% --------------------
\def\x{{\mathbf x}}
\def\L{{\cal L}}

% Title.
% ------
\title{NEAR EARTH BODY DETECTION and linking}
%
% Single address.
% ---------------
\name{ P. Rajan$^{1}$ P. Burlina$^{1,2}$ M. Chen$^{2}$ B. Jedynak$^{3}$  N. Mehta$^{2}$ A. Sinha$^{4}$ G. Hager$^{1}$
\thanks{This work was supported by an Early Stage Innovations grant from NASA's Space Technology Research Grants
Program NNX14AB04G.}}
\address{The Johns Hopkins University  \\   $^{1}$Dept. of Computer Science, $^{2}$Applied Physics Laboratory \\ $^{3}$Dept. of Applied Mathematics and Statistics $^{4}$Dept. of Electrical and Computer Engineering}
%
% For example:
% ------------
%\address{School\\
%	Department\\
%	Address}
%
% Two addresses (uncomment and modify for two-address case).
% ----------------------------------------------------------
%\twoauthors
%  {A. Author-one, B. Author-two\sthanks{Thanks to XYZ agency for funding.}}
%	{School A-B\\
%	Department A-B\\
%	Address A-B}
%  {C. Author-three, D. Author-four\sthanks{The fourth author performed the work
%	while at ...}}
%	{School C-D\\
%	Department C-D\\
%	Address C-D}
%
\begin{document}
%\ninept
%
\maketitle
%
\begin{abstract}
Most asteroid population discovery has been accomplished to-date by earth-based telescopes. It is speculated that most of the smaller Near Earth Objects (NEOs), up to 140 meters in diameter, whose impact can create substantial city-size damage, have not yet been discovered.  Many asteroids  cannot be detected with an earth-based telescope given their size or the location of the Sun.  Our objective is therefore to develop an efficient asteroid detection and linking algorithm that can be hosted on-board a spacecraft.  By having on-board algorithms, the system would also minimize the need to downlink entire images taken by a space-based telescope. We describe an image processing algorithm that we have developed for onboard asteroid detection and characterize its performance.
 
\end{abstract}
%
\begin{keywords}
Asteroids detection, identification. 
\end{keywords}
%
\section{Introduction}
\label{sec:intro}

NASA has a congressional mandate to discover all Near-Earth Objects (NEOs) at least 1 kilometer in diameter.  Fortunately, 95\% of the NEOs larger than 1 km that have been discovered are likely not to impact Earth.  
Near-Earth Object search programs~\cite{stokes2002near} are currently almost exclusively accomplished by earth-based telescopes such as MIT's LINEAR \cite{evans2003detection}  project, the NEAT~\cite{neat2014} program, the Catalina Sky Survey, or  Pan-STARRS~\cite{denneau2013pan}.  An exception is JPL's spacecraft-based WISE telescope brought out of hibernation to characterize NEOs in the 3.4 and 4.6 micron infrared bands~\cite{wise2014} (called NEOWISE). 

It is notable, however, that the NEO that has impacted Chelyabinsk, Russia on 15 February 2013 was only about 17 meters.  The impact of a 50 meter asteroid that caused the Tunguska Event of 1908 could have destroyed an entire city or metropolitan area. It is estimated that only a relatively small fraction of those so called ``city-killing'' asteroids, particularly objects less than 140 meters in diameter, have been discovered to date. Because of their size, atmospheric effects and the location of the sun, some of these NEOs cannot easily be detected with an earth-based telescope.  

Our focus here is therefore on developing an algorithm that can be hosted on-board a spacecraft.  Understanding that there are processing and resource (memory) constraints on-board, our algorithm design needs to not only meet the performance objectives of detecting and identifying asteroids using a space-based telescope, but it also needs to have a small footprint to be implementable with the limited on-board resources.  This paper describes an agile algorithm candidate that is being investigated as well as our use of representative real and simulation imagery for testing it.

%Prior image analysis work for asteroid detection for ground-based image observations is summarized: 
Notable prior work includes~\cite{denneau2013pan}, describing a reference processing system for detection and identification of asteroids named the Pan-STARRS Moving Object Processing System (MOPS). This pipeline aims at identifying moving objects in our solar system and linking those detections within and between night observations. It attributes those detections to known objects, calculates initial and differentially corrected orbits for linked detections, recovering detections when they exist, and orbit identification. Most proposed pipelines for earth based detection include a step to combine images into	 a high S/N static-sky image that is subtracted from the current master image to obtain a difference image containing only transient sources. Examples include \cite{shao2014finding}, where a shift-and-add technique is used to improve  signal to noise ratio and then synthetically creating long exposure images to facilitate the detection of trajectories. A related shift-and-add method using a median  image rather than an average image is reported in~\cite{yanagisawa2005automatic}. A match filter is used for asteroid detection and matching in \cite{gural2005matched}. In \cite{kubica2005variable,kubica2005multiple,kubica2007efficient}, tree based searches (including KD-trees) are used for efficient linking of successive asteroids detections and finding sets of observation points that can be fitted with an inherent motion model, through an exhaustive search for all possible linkages that satisfy the model constraints.
	
	This paper describes a small-footprint pipeline (with regard to memory and CPU usage) that can be deployed on a flight-qualified hardware. When compared to prior work, the salient features of this study are its focus on space-based applications, in particular, (a) we use a combination of Principal Component Analysis and 2d-trees to efficiently link detections into trajectories (see Section~\ref{sec:approach} describing our approach); (b) we employ a simulation engine relying on principled optics  models to characterize  performance on realistic space-based imagery, along with a combination of real image datasets (NEAT and CSS) (Section~\ref{sec:experiments}).
		
%In Section~\ref{sec:approach} we describe a small-footprint pipeline (with regard to memory and CPU usage) that can be deployed on a flight-qualified hardware. This approach uses Principal Component Analysis  to link detections into trajectories. 
%Since space-based asteroids surveys such as NEOWISE are still rare, 
%We describe in Section~\ref{sec:experiments} a validation method using space-based simulated images as well as  image datasets with associated ground truth.

\section{Approach}
\label{sec:approach}

The main components of our image processing pipeline addressing detection and linking of asteroids and taking as input a sequence of time-lapse images acquired from space-based platforms is now described  (also detailed in 
%flow chart in Fig~\ref{IPP} and 
 pseudocode~\ref{code}):

\noindent
{\bf Image Pre-Processing} Median filtering is applied  to reduce impulsive noise and artifacts that depend on the acquisition.\\
{\bf Image Registration}
Image registration is used to bring the images into alignment with a common image of reference so that the stars in the background line up in all images.  In the case of a triplet of images, the second image is used as reference.  We use a similarity transformation (translation, rotation, scaling) and/or skew (full affine transformation) to align all images in the sequence.  Our registration uses mutual information~\cite{viola1997alignment} to estimate the transformation parameters.

{\bf Image Logical Differencing}
A global thresholding is applied to the registered image for detecting asteroids and suppressing background noise.  As asteroids are typically very faint compared to the surrounding stars, the selection of the detection threshold impacts false alarm rate.  Thresholding yields binary detection images.  The set of all binary images is then used to generate an intersection image that contains objects that occur in all images in the sequence.  This is followed by logical differencing whereby we produce a set of difference images by intersecting the corresponding binary image with the negative of the common intersection image.  This operation provides a list of candidate detections (movers) for each image in the sequence.  While the logical differencing results in good detections, additional artifacts such as crater-like formations (see Fig.~\ref{IPP_NEAT_Layout1}) are seen as a result of some celestial bodies being over-exposed.  To mitigate this artifact, we also perform connected components and filtering out of hollow objects as well as filtering based on object size.

{\bf Trajectory Linking}
The list of centroids of moving objects obtained from image differencing defines a set of candidate rectilinear trajectories.  The goal is to find a subset of centroids that fit a linear model. The set of filtered centroids potentially has a high number of noisy points (falsely detected movers), and the cardinality of the set of all candidate trajectories increases exponentially with the number of detections, thus requiring subsequent pruning. We therefore combine PCA and 2d-trees to efficiently find trajectories. Unlike MOPS~\cite{denneau2013pan} and CSS\cite{css2014}, we do not set an upper limit on the velocity of the asteroid, and hence do not risk missing fast movers. Given a sequence of images, we form all the possible trajectories connecting the detections in the first and last frames. There are $O(n^2)$ trajectories, where $n$ is the number of detections per image. We then find the point of intersection of each of these trajectories with the middle frames. We construct a 2 dimensional tree for all the middle frames, and perform a range search on the tree to generate detections that lie near the point of intersection. This query can be done on $O(log(n))$ time on average. Once we find a collection of such points that potentially form a linear trajectory, we perform PCA and compute the ratio of eigenvalues to develop a line confidence score for each candidate trajectory, and choose lines that have high confidence. Using the candidate trajectories thus found, we then enforce temporal ordering by using the sign of the projection on the principal eigenvector.  As a final step, we eliminate false positives by ensuring that the distance between projections is proportional to the time interval between images. Compared to a brute force line search of $O(n^3)$ for a triplet of images, our algorithm takes $O(n^2log(n))$ time.


%\tikzstyle{block} = [rectangle, minimum width=1.8cm, minimum height=1.5cm, text centered, text width=1.8cm, draw=black, fill=blue!15]
%\tikzstyle{arrow} = [thick,->,>=stealth]
%\begin{figure}[b]
%\begin{tikzpicture}[node distance=2.25cm]
%\node (proc) [block] {Image Pre-Processing};
%\node (reg) [block, right of=proc] {Image Registration};
%\node (diff) [block, right of=reg] {Logical Differencing};
%%\node (det) [block, right of=diff, yshift=1.2cm] {Trajectory Detection};
%\node (det) [block, right of=diff] {Trajectory Linking};
%\draw [arrow] (proc) -- (reg);
%\draw [arrow] (reg) -- (diff);
%\draw [arrow] (diff) -- (det);
%\end{tikzpicture}
%\vspace{-0.7cm}
%\caption{Image Processing Pipeline}
%\label{IPP}
%\end{figure}

%The pipeline is summarized as follows: as input to the pipeline is a sequence of time-lapse images. Pre-processing and image registration are used to bring the images into alignment with a common image of reference.  Detection of bright bodies is done via thresholding, followed by logical differencing between each image and a reference image containing objects that are common to all registered images in the image sequence.  After differencing, which allows us to detect moving objects, we use an additional step to filter detections based on size and shape considerations (using connected components and morphological filters).  A list of detection coordinates is generated.  Candidate trajectories are then generated from these coordinates by efficiently checking rectilinearity by using both Principal Component Analysis (PCA) and 2d-trees.  A last verification step further checks additional conditions such as the fact that candidate trajectories must be composed of temporally consecutive mover observations.  Component module are detailed next. 
%
%
%{\bf Image Pre-Processing}
%%We standardize the input images by using a series of photometric and geometric transformations.  
%This step includes employing techniques to reduce noise (e.g. median filter) and artifacts that depend on the acquisition device.   %This coordinate information can then be stored in the FITS (Flexible Image Transport System) image header for later use in the Trajectory Verification stage.
%
%{\bf Image Registration}
%%Image registration aims at finding the transformation that would align multiple images of the same scene that are obtained at different times from slightly different viewpoints.  
%We aim to align each image in the sequence to a common reference image so that the stars in the background line up in all images.  In the case of a triplet of images, the second image is used as the reference image.  We estimate and then apply the necessary similarity transformation (translation, rotation, scaling) and/or skew (for a full affine transformation) to all images in the sequence such that image objects (stars) are mapped into the same pixel location and so that all transformed images have the same spatial resolution.  Image Registration using mutual information~\cite{viola1997alignment} and cross-correlation as similarity measures are used. 
%
%{\bf Image Logical Differencing}
%A global thresholding is applied to the registered image for detecting asteroids and suppressing background noise.  As asteroids are typically very faint compared to the surrounding stars, the selection of the detection threshold impacts false alarm rate.  Thresholding yields binary detection images.  The set of all binary images is then used to generate an intersection image that contains objects that occur in all images in the sequence.  This is followed by logical differencing whereby we produce a set of difference images by intersecting the corresponding binary image with the negative of the common intersection image.  This operation provides a list of candidate detections for each image in the sequence.  While the logical differencing results in good detections, additional artifacts such as crater-like formations (see Fig.~\ref{IPP_NEAT_Layout1}) are seen as a result of some of the celestial bodies being over-exposed.  To mitigate this artifact, we subsequently perform filtering out of hollow objects as well as filtering based on object size.
%
%{\bf Trajectory Linking}
%The list of centroids of moving objects obtained from image differencing defines a set of candidate rectilinear trajectories.  The goal is to find a subset of centroids that fit a linear model. Even though the model is simple, the set of filtered centroids potentially has a high number of noisy points (falsely detected movers), and the cardinality of the set of all candidate trajectories increases exponentially with the number of detections, thus requiring subsequent pruning of this set. We use a combination of PCA and 2d-trees in order to find the trajectories efficiently. Unlike MOPS~\cite{denneau2013pan} and CSS\cite{css2014}, we do not set an upper limit on the velocity of the asteroid, and hence do not risk missing potential fast moving targets. Given a sequence of images, we form all the possible trajectories connecting the detections in the first and last frames. There are $O(n^2)$ trajectories, where $n$ is the number of detections per image. We then find the point of intersection of each of these trajectories with the frames in the middle. We construct a 2 dimensional tree for all the frames in the middle, and perform a range search on the tree to generate the detections that lie within a small radius of the point of intersection. This query can be done on $O(log(n))$ time on average. Once we find a collection of such points that potentially form a linear trajectory, we perform PCA and compute the ratio of eigenvalues, $\lambda_{1}/(\lambda_{1}+ \lambda_{2})$ in order to develop a line confidence score for each candidate trajectory, and choose lines for which this ratio exceeds a threshold. Using the candidate trajectories thus found, we then enforce temporal order of detection by using the sign of the projection on the principal eigenvector.  As the final step, we further eliminate false positives by ensuring that the distance between projections is proportional to the time interval between images. Compared to a brute force line search of $O(n^3)$ for a triplet of images, our algorithm takes $O(n^2log(n))$ time.
%Compared to a brute force line search ($O(n^k)$, where $k$ is the number of images in the sequence) our algorithm takes $O(n^2log(n))$ time.

\vspace{-0.1cm}
\alglanguage{pseudocode}
\begin{algorithm}[H]
\small
\caption{Detection and Linking Algorithm for a sequence of images}
\label{algo:Trajectory_Linking}
\begin{algorithmic}[1]
\State Median filter all images in the sequence.
\State Align all the images to a reference frame (e.g. the second image for a triplet) using Mutual Information based registration.
\State Perform thresholding on the registered images using a pre-defined threshold to generate  binary detection images. 
\State Form the logical intersection image from all the binary detection images, then perform logical differencing between each detection image and the negative of the intersection image.
\State Subsequently filter out hollow objects to produce a set of candidate moving objects on each image.  
\State Form the set of all trajectories connecting the candidate moving object detections from the first and last frame.
\State Construct 2d-trees for the difference images corresponding to the frames in the middle, excluding the first and last frames. Each node of the tree stores the bounding box of all its children. 
\ForAll{trajectories connecting the first and last frames}	
\State Find the points of intersection of each trajectory with the middle frames.
\State Perform range search on the 2d-trees to find a list of detections near this point of intersection within each difference image. 
\State Perform PCA on this subset of trajectories connecting points from all frames in the sequence. Find the ratio of eigenvalues, $\lambda_{1}/(\lambda_{1}+ \lambda_{2})$. Reject trajectories for which this ratio exceeds a line confidence threshold. Ensure that the distance between projections is proportional to the time interval between images. 
\EndFor
\end{algorithmic}
\label{code}
\end{algorithm}
\vspace{-0.3cm}
\vspace{-0.3cm}
\input{Experiments}

\vspace{-0.3cm}
\section{CONCLUSION}
Detecting smaller {\em city-killer} asteroids in space-based surveys is important, as these  are not easily seen in earth-based surveys. We describe a pipeline for on-board NEO detection and characterize its performance on simulated space-based as well as real imagery and show that quadruplets offer much higher performance with little incidence on complexity. Performance results and preliminary computational requirements are promising with regard to the possible future deployment of this algorithm on spacecraft processors such as the RAD750. 

% Below is an example of how to insert images. Delete the ``\vspace'' line,
% uncomment the preceding line ``\centerline...'' and replace ``imageX.ps''
% with a suitable PostScript file name.
% -------------------------------------------------------------------------
%\begin{figure}[t]
%
%\begin{minipage}[b]{1.0\linewidth}
%  \centering
%  \centerline{\includegraphics[width=8.5cm]{Figures/image1}}
%%  \vspace{2.0cm}
%  \centerline{(a) Result 1}\medskip
%\end{minipage}
%%
%\begin{minipage}[b]{.48\linewidth}
%  \centering
%  \centerline{\includegraphics[width=4.0cm]{Figures/image3}}
%%  \vspace{1.5cm}
%  \centerline{(b) Results 3}\medskip
%\end{minipage}
%\hfill
%\begin{minipage}[b]{0.48\linewidth}
%  \centering
%  \centerline{\includegraphics[width=4.0cm]{Figures/image4}}
%%  \vspace{1.5cm}
%  \centerline{(c) Result 4}\medskip
%\end{minipage}
%%
%\caption{some placeholder figure.}
%\label{fig:res}
%%
%\end{figure}


% To start a new column (but not a new page) and help balance the last-page
% column length use \vfill\pagebreak.
% -------------------------------------------------------------------------
%\vfill
%\pagebreak


% References should be produced using the bibtex program from suitable
% BiBTeX files (here: refs). The IEEEbib.bst bibliography
% style file from IEEE produces unsorted bibliography list.
% -------------------------------------------------------------------------
\bibliographystyle{IEEEbib}
\bibliography{asteroid}
\newpage
\input{cpu}

\end{document}
